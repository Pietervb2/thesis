\chapter{Problem formulation and research plan}\label{chap::PoA}
As mentioned in Section \ref{chap::intro}, the objective of this thesis is to lower the return temperature of the decentralized solutions. To achieve this, a dynamic simulation model needs to be made that captures the thermodynamic and hydraulic behavior of these networks to predict the return temperature. It will be used to determine optimal control policies for the supply temperature and the overflow mechanism through data-driven optimization techniques to reduce the return temperature. This research focuses on the Cooltower as a use case, but preferably, the findings should also apply to other networks. This chapter presents the problem formulation and outlines the research plan, detailing the approach for building the model and performing the control policy. 

\section{Problem Formulation} 
\subsection{Graph}
The overall model structure of the district heating network was decided to be a strongly connected directed graph. The looped and branched nature of district heating networks makes them well suited for a graph, which is commonly used in the literature \cite{sibeijn2025economic, Krug2020,OPPELT2016336,Simonssongraph}. The strong connectedness indicates that no water leaves the system. The graph is defined as $\mathcal{G}=(\mathcal{N}, \mathcal{E})$, with a set of nodes $\mathcal{N}$ that represent the junctions in the network. In our model, the nodes correspond to volumeless junctions. Nodes are connected by the edges $\mathcal{E} \subseteq \mathcal{N} \times \mathcal{N}$. An edge is a pipe, potentially equipped with a heat exchanger, pump, or valve. 

\subsection{Edges}
The dynamics of an edge ($e \in \mathcal{E}$) can be described with the two PDEs, derived in Sections \ref{sec::hydropipes} and \ref{sec::thermopipes}.

\begin{equation}\label{eq::formom}
\partial_x p_e + \rho_w g \hat{z} + f \frac{8\rho_w L}{\pi^2 D^5}\left|q_e\right|q_e =0
\end{equation}
\begin{equation}\label{eq::forsimpipePDE}
\rho_w c_w A \frac{\partial T_e}{\partial t} + \dot{m}_e c_w \frac{\partial T_e}{\partial x}=\frac{\left(T_a-T_e\right)}{R'} + w_e
\end{equation}
The hydraulics relation can be  discretized $\partial_x p = \frac{\Delta p}{L}$ which leads to
\begin{equation}\label{eq::thermopde}
    \Delta p_e = f \frac{8\rho_w L}{\pi^2 D^5}\left|q_e\right|q_e + \rho_w g L \hat{z}.
\end{equation}
When a pump is connected to an edge, the pressure loss over the edge becomes
% \begin{equation}
%     \Delta p_e = R_{f}\,\dot{m_e}^2 + \rho_w g L \hat{z} - h_e(r_e) 
% \end{equation}
\begin{equation}
    \Delta p_e = R_{f}\,\dot{m_e}^2 + \rho_w g L \hat{z} - \sum^{\text{n}}_{\text{i=1}} \left( c_i(\omega)  \rho \ \dot{V}^{i}_e \right)
\end{equation}

% h_e(r) = c_er_e$ being the pressure increase applied by the pump, $c_e$ the maximum pumping power capacity, and $r_e \in [0,1]$ the pump frequency rate
with $R_{f}$ a combined constant term representing the frictional resistance of the pipe \cite{sibeijn2025economic}. In case of the edge containing a valve the extra pressure drop over the edge changes accordingly to its definition from Section \ref{sec::valves}. The second Kirchhoff law states that the net pressure difference over a closed loop must be zero. A set of edges connected in a closed loop are defined as $\mathcal{E}_{\text{loop}} = \left\{e \in \mathcal{E} : e \ \text{in closed loop}\right\}$, formulating the relation as:
\begin{equation}
    \sum_{e  \in \mathcal{E}_{\text{loop}}} \Delta p_e = 0.
\end{equation}
The use of the Kirchhoff laws leads to a system of non-linear equations. Hardy-Cross and the Newton-Raphson methods are often used to to solve such system \cite{KUNTUAROVA}. However, in the case of low flow rate these methods experience weak convergence. The method developed by Arsene et al. \cite{ARSENE} which can handle this and will be applied.  


In the thermodynamic PDE, \ref{eq::thermopde}, the term $w$ [J/(m s)] is added, representing the power transfer per meter of pipe with a heat exchanger. The equation will be solved using the Node Method as it is the most widely applied approach in a dynamic district heating network setting. While other methods potentially offer greater accuracy of efficiency, they have not been extensively tested and validated using real-world data like the Node Method \cite{KUNTUAROVA}.

\subsection{Nodes}
The first Kirchhoff law states that the sum of flows entering a node equals the sum of flows exiting the node. Resulting in the conservation of mass over every node due to the assumed incompressibility of the water. For any node $n \in \mathcal{N}$, the edge sets $\mathcal{E}_{\rightarrow n} = \left\{ e \in \mathcal{E} : e \  \text{enters} \ n\right\}$ and $\mathcal{E}_{n\rightarrow } = \left\{ e \in \mathcal{E} : e \  \text{exits} \ n\right\}$ are respectively the entering and exiting sets of edges. The mass conservation is given by
\begin{equation}
    \sum_{e  \in \mathcal{E}_{\rightarrow n}} q_e(t) = \sum_{e  \in \mathcal{E}_{n \rightarrow}} q_e(t).
\end{equation}
Because frictional heat is neglected and heat capacity is assumed constant, the energy balance in every node can be used to define a mixing rule for the node's temperature based on the incoming water temperatures. For every $n \in \mathcal{N}$ it gives
\begin{equation}
    T_n(t) = \frac{\sum_{e  \in \mathcal{E}_{\rightarrow n}} q_e(t) T_e(t)}{\sum_{e  \in \mathcal{E}_{\rightarrow n}} q_e(t)},
\end{equation}
with the nodal temperature being the temperature of all the exiting edges \cite{Krug2020}. 
\begin{equation}
    T_n(t) = T_e(t), \quad \forall \ n \in \mathcal{N}, e \in \mathcal{E}_{n \rightarrow} 
\end{equation}

\subsection{Heat demand}
The individual user heat demand profile is assumed to be deterministic and will be represented by a summation of sines approximating the user demand profile from \cite{Krug2020}. 

\begin{equation}
Q_{d,n_c}(t)=A_1 \sin(\frac{2 \pi}{T_1} t + \phi_1) + A_2\sin(\frac{2 \pi}{T_2} t + \phi_2)
\end{equation}
with $Q_{d,n_c}(t)$ [W] as the heat demand for individual user $n_c \in \left\{1,2,...,N_c \right\}$ with $N_c$ as the total number of customers. The arrow of all the individual user profiles is called $Q_d(t)$, and contains a time shift variable $\tau_{n_c}$, introduced to create a difference between the individual user heat demand profiles.

\begin{equation}
Q_d(k) = 
\left[\begin{array}{c}
Q_{d,1}(k-\tau_1) \\
Q_{d,2}(k-\tau_2) \\
\vdots \\
Q_{d,N_c}(k - \tau_{N_c})
\end{array}\right].
\end{equation}

\subsection{Heat production}
The total heat production can be divided into two components: heat extracted from the ATES and heat supplied by a larger district heating network acting as a backup. The working of the heat pump connected to the ATES in combination with the backup network is defined in the energy balance below:
\begin{equation}
    \rho_w c_w q_e(t) \left(T_s(t) - T_r(t)\right) = \rho_w c_w q_{A}(t)\left(T_{s,A} - T_{r,A}\right) + Q_e(t) + Q_{b}(t),
\end{equation}
with $q_A(t)$ [m$^3$/s] as the flow rate on the ATES side, $T_{s,A}$ and $T_{r,A}$ [$^{\circ}\text{C}$] respectively the supply and return temperature on the ATES side and $Q_e(t)$ [W] is the electric power delivered to the compressor. The temperatures $T_{r,A}$ and $T_{s,A}$ are assumed constant. In case the ATES cannot provide enough energy, the backup network fills the energy gap. The amount of heat delivered by the backup network is stated as $Q_{b}(t)$ [W].

\subsection{Control problem}
The developed discrete model of the DCS for time instance $k$ is given by

\begin{align}
& T_r(k) = f(x(k), u(k)) \notag \\
& x(k) = 
\left[\begin{array}{cc}
T_{s,1}(k) & \dot{m}_1(k)  \\
T_{s,2}(k) & \dot{m}_2(k) \\
 \vdots  & \vdots \\
T_{s,N_c}(k) & \dot{m}_{N_e - 1}(k) \\
\varnothing & \dot{m}_{N_e}(k)  
\end{array}\right], \quad x(k) \in \mathcal{X\\
&u(k) =  \left[\begin{array}{cccc}
h_{\text{lift}}(k) & q_A(k) & Q_p(k) & Q_e(k) 
\end{array}\right], \quad u(k) \in \mathcal{U} \notag 
\end{align}
With $T_{s,n_c}$ [$^{\circ}\text{C}$] the supply temperature at delivery set $n_c$, and $\dot{m}_{e}$ the mass flow at edge $e \in \left\{1,2,...,N_e \right\}$. When the model is used to generate the necessary data for the Bayesian Optimization, the input space $\mathcal{U}$ will be limited by the range of the input variables but also by the state space $\mathcal{X}$ as the mass flow and minimum water temperature are limited based on the time required for the delivery sets to reach a water temperature of 65 $^{\circ}\text{C}$. 

Bayesian Optimization is used because the model has become computationally intensive. It is caused by the Node Method and the hydraulics being a system of nonlinear equations. As the Node Method is non-differentiable and contains integers, the optimization of the whole system becomes a Mixed Integer Non-Linear problem (MINLP), which is time-consuming to solve \cite{MAURER2021244}. Instead of choosing another method, such as describing the thermodynamic behavior of the pipes or simplifying the nonlinear hydraulic equations, which may decrease the model's accuracy, we choose to apply Bayesian Optimization. In this way, the accuracy of the simulation model is still guaranteed and can also be applied for optimization. The resulting optimization formulation is stated by 

\begin{align}
\min_{u(k)} & \quad f(u(k)) \\
\text{s.t.} & \quad E_1 u(k)  \leq g_1 \notag 
\end{align}
\todo[inline]{moet je hier x(k) ook vermelden}
\section{Research Plan}
This section outlines the research approach, discussing the use of simulation software, detailing the step-by-step development of the model, and the implementation of the optimization process.

\subsection{Simulation software}\label{sec::SimulationModel}
An overview of possibly suitable simulation tools was presented in Table \ref{tab::simsoft}. The paid license tools IDA ICE and TRNSYS are potentially very interesting due to their dynamic modeling capability. However, it was decided to proceed with a non-commercial program due to the high cost and the drawback that these programs are not used at Eneco, making implementation more difficult. IDA ICE has a free educational license, but this won't be valid anymore after this thesis is completed. The second argument also holds for the programs EnergyPLAN and EnergyPlus. Besides the fact that EnergyPLAN uses an hourly timestep, and EnergyPlus focuses on building thermal behavior without detailed network modeling. The most serious option of the non-Python tools was OpenModelica, which is an open-source software tool that supports the Modelica language \cite{Modelica}. Although the Modelica language is commonly used for DHN modeling \cite{KUNTUAROVA}, the OpenModelica documentation is not elaborate, making debugging more difficult. Since using it would also require Eneco employees to learn a new modeling language, we decided not to proceed with OpenModelica.

Therefore, the focus was pointed towards Python-based open-source software. PyDHN and GridPenguin support dynamic simulation of the thermodynamics. Nevertheless, PyDHN is still a beta version, and GridPenguin's fixed timestep is 1 hour, making both tools unsuitable. Pandapipes offers a quasi-static approach without a fixed minimum timestep. While it is an interesting option, the time required to understand its coding structure and the potential time debugging would take was considered greater than developing our model from scratch

Therefore, it was determined to make the model from scratch in Python using the Python open-source projects as inspiration for the model structure.

\subsection{Model development}
The construction of the model will be done in a stepwise manner, gradually increasing the level of complexity. Every step will be tested against a couple of base tests checking the conservation of mass in the nodes, the temperature development along the network, and how the pressure and temperature in the system change due to a variation in heat demand. Some steps include additional tests, which are described at each corresponding level. The model development procedure is outlined below

\begin{enumerate}
\item Develop a graph-based framework to represent the network topology.
\item Implement the thermodynamic model for a pipeline.
\begin{itemize}
\item Validate the implementation by comparing it with the dynamic pipe model from the Standard Modelica Library and real pipeline data.
\end{itemize}
\item Construct a basic looped network configuration.
\item Integrate producers, consumers, and heat exchangers into the network.
\item Build a simplified network with two consumers and one producer. \label{networkstep}
\item Incorporate pressure calculations and add components such as valves, pumps, and an overflow mechanism.
\item Repeat step \ref{networkstep} with the updated hydraulic elements.
\item Scale up the network to include 20 consumers and 2 producers.
\begin{itemize}
    \item Verify the model by creating different heat demand profiles through applying time shifts of the peaks. 
\end{itemize}
\item Reproduce the DCS (District Control System) of the Cooltower.
\begin{itemize}
\item Validate internal supply temperatures for each delivery set using available data. Additionally, use supply and demand data, along with return temperature measurements, to assess model accuracy.
\end{itemize}
\end{enumerate}

\subsection{Control Policy}
Once the validated model is obtained, it will be used to generate data for implementing Bayesian Optimization. The correct acquisition function and covariance kernel need to be found to make it properly fit the model of the DCS. The performance of the Bayesian Optimization will then be evaluated across various combinations of control inputs and different model parameters. 


